name: Release & Publish

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      publish_to_marketplace:
        description: 'Publish to VS Code Marketplace'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  VSCODE_VERSION: '1.74.0'

jobs:
  # Release Build Job
  release-build:
    name: Release Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run full test suite
      run: npm run test:ci
      
    - name: Build extension
      run: npm run compile
      
    - name: Create VSIX package
      run: node create-vsix.js
      
    - name: Get version from package.json
      id: version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: Rename VSIX with version
      run: |
        mv cursor-ai-workflow-automation-*.vsix cursor-ai-workflow-automation-${{ steps.version.outputs.version }}.vsix
      
    - name: Upload VSIX release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./cursor-ai-workflow-automation-${{ steps.version.outputs.version }}.vsix
        asset_name: cursor-ai-workflow-automation-${{ steps.version.outputs.version }}.vsix
        asset_content_type: application/octet-stream
        
    - name: Create release notes
      id: release_notes
      run: |
        # Generate changelog from commits
        CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Update release description
      uses: actions/github-script@v7
      with:
        script: |
          const { data: release } = await github.rest.repos.getRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id
          });
          
          const changelog = '${{ steps.release_notes.outputs.changelog }}';
          const description = `## 🚀 Cursor AI Workflow Automation v${{ steps.version.outputs.version }}
          
          ### 📦 What's New
          ${changelog}
          
          ### 🔧 Installation
          1. Download the VSIX file from this release
          2. Open Cursor IDE
          3. Go to Extensions (Ctrl+Shift+X)
          4. Click the "..." menu and select "Install from VSIX..."
          5. Select the downloaded file
          
          ### 🎯 Features
          - Intelligent AI workflow automation
          - Comprehensive analytics and ROI tracking
          - Multi-IDE support (Cursor, Windsurf)
          - Advanced button detection and automation
          - Real-time performance monitoring
          
          ### 📊 Test Coverage
          - Unit Tests: ✅ Passing
          - Integration Tests: ✅ Passing
          - E2E Tests: ✅ Passing
          - Coverage: >80%
          
          ### 🔒 Security
          - Security scan: ✅ Passed
          - Dependency audit: ✅ Clean
          
          ### 📝 Documentation
          - [README.md](https://github.com/0xb007ab1e/cursor-ai-workflow-automation#readme)
          - [Installation Guide](https://github.com/0xb007ab1e/cursor-ai-workflow-automation/blob/main/FORK-README.md)
          - [Future Features](https://github.com/0xb007ab1e/cursor-ai-workflow-automation/blob/main/FUTURE-FEATURES.md)
          
          ### 🤝 Contributing
          - Fork the repository
          - Create a feature branch
          - Submit a pull request
          
          ### 📄 License
          MIT License - see [LICENSE](https://github.com/0xb007ab1e/cursor-ai-workflow-automation/blob/main/LICENSE) for details
          
          ### 👨‍💻 Authors
          - **Maintainer**: [@0xb007ab1e](https://github.com/0xb007ab1e)
          - **Original Author**: [@ivalsaraj](https://github.com/ivalsaraj)
          
          ---
          
          *Built with ❤️ for the Cursor IDE community*`;
          
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: description
          });

  # Publish to Marketplace Job
  publish-marketplace:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: release-build
    if: ${{ github.event.inputs.publish_to_marketplace == 'true' || contains(github.event.release.body, 'publish') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install vsce
      run: npm install -g @vscode/vsce
      
    - name: Install dependencies
      run: npm ci
      
    - name: Build extension
      run: npm run compile
      
    - name: Publish to VS Code Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        # Publish to marketplace
        vsce publish --pat $VSCE_PAT
        
        echo "✅ Extension published to VS Code Marketplace"
        
    - name: Notify success
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.release.id,
            body: `🎉 **Extension successfully published to VS Code Marketplace!**
          
          📦 **Package**: cursor-ai-workflow-automation
          🔗 **Marketplace**: https://marketplace.visualstudio.com/items?itemName=0xb007ab1e.cursor-ai-workflow-automation
          📅 **Published**: ${new Date().toISOString()}
          
          Users can now install the extension directly from the VS Code marketplace!`
          });

  # Create Release Tag Job
  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: release-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Get version
      id: version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: Create and push tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"
        
    - name: Notify tag creation
      uses: actions/github-script@v7
      with:
        script: |
          console.log(`✅ Release tag v${{ steps.version.outputs.version }} created and pushed`);
